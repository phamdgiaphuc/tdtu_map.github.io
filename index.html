<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TDTU Pathfinder â€” Optimized (Pan+Zoom sync + Edit nodes + Help)</title>
<style>
  :root{
    --bg:#0d0f11; --panel:#0f1113; --muted:#9aa; --accent:#ffd86b;
  }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#eee}
  header{display:flex;align-items:center;gap:12px;padding:10px;background:#0b0b0b;border-bottom:1px solid #141414}
  header h1{margin:0;font-size:16px}
  #controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  button{background:#1b1c1f;border:1px solid #222;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
  button.secondary{background:transparent;border:1px solid #333;color:var(--muted)}
  #wrap{display:flex;gap:12px;height:calc(100vh - 72px);padding:12px;box-sizing:border-box}
  #left{flex:1;display:flex;flex-direction:column;gap:8px}
  #canvasWrap{border-radius:8px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.6);background:#000;flex:1;display:flex;align-items:center;justify-content:center}
  canvas{display:block;max-width:100%;height:auto;cursor:grab;background:#000}
  #side{width:360px;background:var(--panel);padding:12px;border-radius:8px;border:1px solid #222;height:100%;overflow:auto}
  label{font-size:13px;color:var(--muted);display:block;margin-top:8px}
  .small{font-size:13px;color:var(--muted)}
  textarea{width:100%;height:120px;background:#070707;color:#eee;border:1px solid #222;padding:8px;border-radius:6px;resize:vertical}
  #pathOutput{white-space:pre-wrap;background:#060606;padding:8px;border-radius:6px;border:1px solid #222;margin-top:6px;min-height:80px;color:#ddd}
  footer{padding:8px;text-align:center;color:#777}
  .row{display:flex;gap:8px;align-items:center}
  .hint{color:var(--muted);font-size:13px;margin-top:10px}
  .toggle{display:inline-flex;align-items:center;gap:8px}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:999}
  .modal{background:#0b0b0b;border:1px solid #222;padding:18px;border-radius:10px;width:720px;max-width:94%;color:#ddd}
  .modal h2{margin:0 0 8px 0}
  .close-btn{margin-left:auto}
  .btn-group{display:flex;gap:8px}
</style>
</head>
<body>
  <link rel="stylesheet" href="style.css">
  <header>
    <h1>ğŸ§­ TDTU Pathfinder â€” Optimized</h1>
    <div id="controls">
      <button id="btnResetPath">ğŸ” Reset Path</button>
      <button id="btnExport">â¬‡ï¸ Export JSON</button>
      <button id="btnReload">â†º Reload Graph</button>
      <button id="btnHelp">â“ Help</button>
    </div>
  </header>

  <div id="wrap">
    <div id="left">
      <div id="canvasWrap">
        <canvas id="mapCanvas" width="1200" height="800" tabindex="0"></canvas>
      </div>
      <div style="padding:6px 4px;color:#ddd;font-size:13px">
        <span class="small">Pan: kÃ©o giá»¯ chuá»™t (drag). Zoom: bÃ¡nh xe chuá»™t (zoom quanh con trá»). Click chá»n Start â†’ Click chá»n End Ä‘á»ƒ tÃ¬m Ä‘Æ°á»ng. Báº­t "Edit nodes" Ä‘á»ƒ kÃ©o tháº£ node.</span>
      </div>
    </div>

    <aside id="side">
      <label>Snap threshold (canvas px)</label>
      <input id="snapRange" type="range" min="6" max="300" value="60" style="width:100%"/>
      <div class="small">Current snap: <span id="snapVal">60</span> px</div>

      <div style="margin-top:8px" class="row">
        <label style="margin:0">Edit nodes</label>
        <div style="margin-left:auto" class="toggle">
          <input id="editToggle" type="checkbox" />
          <span class="small">Báº­t</span>
        </div>
      </div>

      <label style="margin-top:8px">Graph info</label>
      <div id="info" style="background:#060606;padding:8px;border-radius:6px;border:1px solid #222;font-size:13px">
        Nodes: <span id="nodeCount">0</span><br>Edges: <span id="edgeCount">0</span>
      </div>

      <div style="margin-top:10px"><b>Path output</b></div>
      <div id="pathOutput">No path yet.</div>

      <label style="margin-top:10px">(Optional) Paste JSON to replace graph</label>
      <textarea id="jsonText" placeholder='Paste graph JSON then click "Load JSON"'></textarea>
      <div style="display:flex;gap:8px;margin-top:8px" class="btn-group">
        <button id="btnLoadJson">Load JSON</button>
        <button id="btnClearJson" class="secondary">Clear</button>
      </div>

      <div class="hint">
        Khi Ä‘Ã£ cÄƒn chá»‰nh xong: báº¥m <b>Export JSON</b> â€” file xuáº¥t sáº½ chá»©a tá»a Ä‘á»™ nodes (pixel cá»§a áº£nh gá»‘c).<br>
        Khi <b>Edit nodes</b> báº­t â€” kÃ©o tháº£ node Ä‘á»ƒ chá»‰nh tá»a Ä‘á»™.
      </div>
    </aside>
  </div>

  <footer>Offline. Put <b>tdtu_map.png</b> in same folder as this HTML file and open in browser.</footer>

  <!-- Help modal -->
  <div id="helpModal" class="modal-backdrop" role="dialog" aria-modal="true" style="display:none">
    <div class="modal" role="document">
      <div style="display:flex;align-items:center;gap:8px">
        <h2>â“ HÆ°á»›ng dáº«n - TDTU Pathfinder</h2>
        <button id="closeHelp" class="close-btn" style="margin-left:auto">ÄÃ³ng</button>
      </div>
      <p style="color:#cfcfcf">
        Trang nÃ y cho phÃ©p báº¡n xem báº£n Ä‘á»“ (tdtu_map.png) vÃ  Ä‘á»“ thá»‹ node/edge gáº¯n trÃªn Ä‘Ã³. CÃ¡c chá»©c nÄƒng chÃ­nh:
      </p>
      <ul style="color:#ddd">
        <li><b>Pan (kÃ©o):</b> KÃ©o giá»¯ chuá»™t trÃªn canvas Ä‘á»ƒ di chuyá»ƒn toÃ n bá»™ báº£n Ä‘á»“ + graph cÃ¹ng nhau.</li>
        <li><b>Zoom (bÃ¡nh xe chuá»™t):</b> Quay bÃ¡nh xe Ä‘á»ƒ phÃ³ng/thu; zoom sáº½ xoay quanh vá»‹ trÃ­ con trá» (giá»¯ Ä‘iá»ƒm dÆ°á»›i con trá» cá»‘ Ä‘á»‹nh).</li>
        <li><b>Chá»n Start / End:</b> Click má»™t node (gáº§n con trá») â†’ sáº½ Ä‘áº·t Start; click node thá»© 2 â†’ Ä‘áº·t End vÃ  cháº¡y Dijkstra, Ä‘Æ°á»ng Ä‘á» sáº½ váº½ lÃªn.</li>
        <li><b>Snap threshold:</b> Náº¿u click cÃ¡ch node quÃ¡ xa, tÄƒng ngÆ°á»¡ng Snap (px trÃªn canvas) Ä‘á»ƒ dá»… chá»n.</li>
        <li><b>Edit nodes:</b> Khi báº­t, báº¡n cÃ³ thá»ƒ kÃ©o tháº£ node Ä‘á»ƒ chá»‰nh vá»‹ trÃ­ (Ä‘á»ƒ cÄƒn chá»‰nh thá»§ cÃ´ng). Sau Ä‘Ã³ Export JSON Ä‘á»ƒ lÆ°u tá»a Ä‘á»™ má»›i.</li>
        <li><b>Export JSON:</b> Táº£i file JSON chá»©a tá»a Ä‘á»™ nodes (pixel áº£nh gá»‘c) vÃ  danh sÃ¡ch edges.</li>
        <li><b>Load JSON:</b> DÃ¡n graph JSON (nodes + edges) vÃ o Ã´ vÃ  Load Ä‘á»ƒ thay tháº¿ graph hiá»‡n táº¡i.</li>
        <li><b>Reset Path / Reload:</b> Reset chá»‰ Ä‘Æ°á»ng; Reload khÃ´i phá»¥c graph nhÃºng ban Ä‘áº§u.</li>
      </ul>
      <p style="color:#bbb">Gá»£i Ã½: náº¿u node nhá» khi zoom out, thá»­ zoom gáº§n hÆ¡n Ä‘á»ƒ chá»n hoáº·c tÄƒng Snap.</p>
    </div>
  </div>

<script>
/* =========================
  Optimized Pan+Zoom + Node edit + Dijkstra + Export
  - Drag to pan (no modifier)
  - Wheel to zoom (around mouse)
  - Edit nodes toggle: drag nodes to move (image coords)
  - Efficient render using requestAnimationFrame + dirty flag
  =========================*/

// --------------------- Embedded graph (shortened example, replace with your full embeddedGraph) ---------------------
// NOTE: you can replace embeddedGraph with your large JSON; for brevity here we include the graph the user provided.
// (To keep response manageable we include the same structure variable â€” replace with full node/edge arrays if needed.)

const embeddedGraph = {
  "nodes": [
    {
      "id": "N2",
      "x": 184,
      "y": 581
    },
    {
      "id": "N3",
      "x": 100,
      "y": 634
    },
    {
      "id": "N4",
      "x": 200,
      "y": 601
    },
    {
      "id": "N5",
      "x": 224,
      "y": 647
    },
    {
      "id": "N6",
      "x": 242,
      "y": 572
    },
    {
      "id": "N7",
      "x": 232,
      "y": 550
    },
    {
      "id": "N8",
      "x": 266,
      "y": 601
    },
    {
      "id": "N9",
      "x": 303,
      "y": 575
    },
    {
      "id": "N10",
      "x": 304,
      "y": 532
    },
    {
      "id": "N11",
      "x": 346,
      "y": 525
    },
    {
      "id": "N12",
      "x": 344,
      "y": 499
    },
    {
      "id": "N13",
      "x": 415,
      "y": 493
    },
    {
      "id": "N14",
      "x": 564,
      "y": 476
    },
    {
      "id": "N15",
      "x": 564,
      "y": 453
    },
    {
      "id": "N16",
      "x": 621,
      "y": 473
    },
    {
      "id": "N17",
      "x": 595,
      "y": 469
    },
    {
      "id": "N18",
      "x": 596,
      "y": 506
    },
    {
      "id": "N19",
      "x": 528,
      "y": 511
    },
    {
      "id": "N20",
      "x": 419,
      "y": 517
    },
    {
      "id": "N21",
      "x": 426,
      "y": 564
    },
    {
      "id": "N22",
      "x": 480,
      "y": 563
    },
    {
      "id": "N23",
      "x": 531,
      "y": 557
    },
    {
      "id": "N24",
      "x": 608,
      "y": 584
    },
    {
      "id": "N25",
      "x": 710,
      "y": 574
    },
    {
      "id": "N26",
      "x": 710,
      "y": 543
    },
    {
      "id": "N27",
      "x": 652,
      "y": 542
    },
    {
      "id": "N28",
      "x": 647,
      "y": 503
    },
    {
      "id": "N29",
      "x": 753,
      "y": 489
    },
    {
      "id": "N30",
      "x": 761,
      "y": 533
    },
    {
      "id": "N31",
      "x": 831,
      "y": 558
    },
    {
      "id": "N32",
      "x": 773,
      "y": 459
    },
    {
      "id": "N33",
      "x": 731,
      "y": 396
    },
    {
      "id": "N34",
      "x": 695,
      "y": 402
    },
    {
      "id": "N35",
      "x": 461,
      "y": 488
    },
    {
      "id": "N36",
      "x": 456,
      "y": 435
    },
    {
      "id": "N37",
      "x": 403,
      "y": 421
    },
    {
      "id": "N38",
      "x": 419,
      "y": 378
    },
    {
      "id": "N39",
      "x": 440,
      "y": 328
    },
    {
      "id": "N40",
      "x": 478,
      "y": 257
    },
    {
      "id": "N41",
      "x": 520,
      "y": 182
    },
    {
      "id": "N42",
      "x": 472,
      "y": 309
    },
    {
      "id": "N43",
      "x": 514,
      "y": 302
    },
    {
      "id": "N44",
      "x": 557,
      "y": 299
    },
    {
      "id": "N45",
      "x": 556,
      "y": 326
    },
    {
      "id": "N46",
      "x": 578,
      "y": 295
    },
    {
      "id": "N47",
      "x": 609,
      "y": 293
    },
    {
      "id": "N48",
      "x": 642,
      "y": 296
    },
    {
      "id": "N49",
      "x": 663,
      "y": 305
    },
    {
      "id": "N50",
      "x": 682,
      "y": 325
    },
    {
      "id": "N54",
      "x": 764,
      "y": 262
    },
    {
      "id": "N55",
      "x": 955,
      "y": 544
    },
    {
      "id": "N56",
      "x": 837,
      "y": 726
    },
    {
      "id": "N57",
      "x": 970,
      "y": 715
    },
    {
      "id": "N58",
      "x": 297,
      "y": 639
    },
    {
      "id": "N59",
      "x": 352,
      "y": 605
    },
    {
      "id": "N60",
      "x": 483,
      "y": 598
    },
    {
      "id": "N61",
      "x": 618,
      "y": 664
    },
    {
      "id": "N62",
      "x": 570,
      "y": 664
    },
    {
      "id": "N63",
      "x": 568,
      "y": 609
    },
    {
      "id": "N64",
      "x": 517,
      "y": 612
    },
    {
      "id": "N65",
      "x": 527,
      "y": 720
    },
    {
      "id": "N66",
      "x": 575,
      "y": 706
    },
    {
      "id": "N67",
      "x": 649,
      "y": 659
    },
    {
      "id": "N68",
      "x": 647,
      "y": 626
    },
    {
      "id": "N69",
      "x": 709,
      "y": 614
    },
    {
      "id": "N70",
      "x": 769,
      "y": 607
    },
    {
      "id": "N71",
      "x": 776,
      "y": 708
    },
    {
      "id": "N72",
      "x": 716,
      "y": 711
    },
    {
      "id": "N73",
      "x": 661,
      "y": 717
    },
    {
      "id": "N74",
      "x": 720,
      "y": 744
    },
    {
      "id": "N75",
      "x": 627,
      "y": 754
    },
    {
      "id": "N76",
      "x": 534,
      "y": 769
    },
    {
      "id": "N77",
      "x": 460,
      "y": 771
    },
    {
      "id": "N78",
      "x": 413,
      "y": 772
    },
    {
      "id": "N79",
      "x": 369,
      "y": 767
    },
    {
      "id": "N80",
      "x": 312,
      "y": 760
    },
    {
      "id": "N81",
      "x": 269,
      "y": 753
    },
    {
      "id": "N82",
      "x": 255,
      "y": 728
    },
    {
      "id": "N83",
      "x": 250,
      "y": 699
    },
    {
      "id": "N84",
      "x": 263,
      "y": 667
    },
    {
      "id": "N85",
      "x": 304,
      "y": 690
    },
    {
      "id": "N86",
      "x": 308,
      "y": 740
    },
    {
      "id": "N87",
      "x": 367,
      "y": 743
    },
    {
      "id": "N88",
      "x": 368,
      "y": 646
    },
    {
      "id": "N89",
      "x": 324,
      "y": 468
    },
    {
      "id": "N90",
      "x": 519,
      "y": 484
    },
    {
      "id": "N91",
      "x": 759,
      "y": 197
    },
    {
      "id": "N92",
      "x": 862,
      "y": 200
    },
    {
      "id": "N93",
      "x": 965,
      "y": 210
    },
    {
      "id": "N94",
      "x": 861,
      "y": 233
    },
    {
      "id": "N95",
      "x": 822,
      "y": 261
    },
    {
      "id": "N96",
      "x": 823,
      "y": 315
    },
    {
      "id": "N97",
      "x": 846,
      "y": 305
    },
    {
      "id": "N98",
      "x": 876,
      "y": 305
    },
    {
      "id": "N99",
      "x": 965,
      "y": 260
    },
    {
      "id": "N100",
      "x": 926,
      "y": 257
    },
    {
      "id": "N101",
      "x": 903,
      "y": 271
    },
    {
      "id": "N102",
      "x": 862,
      "y": 352
    },
    {
      "id": "N103",
      "x": 894,
      "y": 387
    },
    {
      "id": "N104",
      "x": 927,
      "y": 438
    },
    {
      "id": "N105",
      "x": 948,
      "y": 491
    },
    {
      "id": "N106",
      "x": 966,
      "y": 609
    },
    {
      "id": "N107",
      "x": 974,
      "y": 668
    },
    {
      "id": "N108",
      "x": 1030,
      "y": 668
    },
    {
      "id": "N109",
      "x": 1025,
      "y": 642
    },
    {
      "id": "N110",
      "x": 1026,
      "y": 690
    },
    {
      "id": "N111",
      "x": 1060,
      "y": 667
    },
    {
      "id": "N112",
      "x": 1068,
      "y": 724
    },
    {
      "id": "N113",
      "x": 1002,
      "y": 745
    },
    {
      "id": "N114",
      "x": 1149,
      "y": 727
    },
    {
      "id": "N115",
      "x": 1146,
      "y": 670
    },
    {
      "id": "N116",
      "x": 1134,
      "y": 529
    },
    {
      "id": "N117",
      "x": 1049,
      "y": 539
    },
    {
      "id": "N118",
      "x": 1055,
      "y": 570
    },
    {
      "id": "N119",
      "x": 1033,
      "y": 572
    },
    {
      "id": "N120",
      "x": 1062,
      "y": 609
    },
    {
      "id": "N121",
      "x": 965,
      "y": 322
    },
    {
      "id": "N122",
      "x": 967,
      "y": 358
    },
    {
      "id": "N123",
      "x": 965,
      "y": 410
    },
    {
      "id": "N124",
      "x": 932,
      "y": 408
    },
    {
      "id": "N125",
      "x": 973,
      "y": 442
    },
    {
      "id": "N126",
      "x": 1047,
      "y": 439
    },
    {
      "id": "N127",
      "x": 1042,
      "y": 402
    },
    {
      "id": "N128",
      "x": 1046,
      "y": 456
    },
    {
      "id": "N129",
      "x": 1128,
      "y": 439
    },
    {
      "id": "N130",
      "x": 1129,
      "y": 232
    },
    {
      "id": "N131",
      "x": 1051,
      "y": 223
    },
    {
      "id": "N132",
      "x": 1051,
      "y": 251
    },
    {
      "id": "N133",
      "x": 1205,
      "y": 517
    },
    {
      "id": "N134",
      "x": 1408,
      "y": 534
    },
    {
      "id": "N135",
      "x": 1467,
      "y": 527
    },
    {
      "id": "N136",
      "x": 1385,
      "y": 380
    },
    {
      "id": "N137",
      "x": 1445,
      "y": 372
    },
    {
      "id": "N138",
      "x": 1437,
      "y": 254
    },
    {
      "id": "N139",
      "x": 1297,
      "y": 243
    },
    {
      "id": "N140",
      "x": 1227,
      "y": 666
    },
    {
      "id": "N141",
      "x": 1349,
      "y": 512
    },
    {
      "id": "N142",
      "x": 1336,
      "y": 534
    },
    {
      "id": "N143",
      "x": 1377,
      "y": 527
    },
    {
      "id": "N144",
      "x": 1358,
      "y": 459
    },
    {
      "id": "N145",
      "x": 1361,
      "y": 389
    },
    {
      "id": "N146",
      "x": 1207,
      "y": 433
    },
    {
      "id": "N147",
      "x": 1203,
      "y": 357
    },
    {
      "id": "N148",
      "x": 1204,
      "y": 247
    },
    {
      "id": "N149",
      "x": 1267,
      "y": 263
    },
    {
      "id": "N150",
      "x": 1275,
      "y": 290
    },
    {
      "id": "N151",
      "x": 1265,
      "y": 321
    },
    {
      "id": "N152",
      "x": 1369,
      "y": 275
    },
    {
      "id": "N153",
      "x": 1378,
      "y": 322
    },
    {
      "id": "N154",
      "x": 1330,
      "y": 318
    },
    {
      "id": "N155",
      "x": 1499,
      "y": 701
    },
    {
      "id": "N156",
      "x": 1350,
      "y": 716
    },
    {
      "id": "N157",
      "x": 1345,
      "y": 689
    },
    {
      "id": "N158",
      "x": 1314,
      "y": 688
    },
    {
      "id": "N159",
      "x": 1309,
      "y": 661
    },
    {
      "id": "N160",
      "x": 1407,
      "y": 678
    },
    {
      "id": "N161",
      "x": 1406,
      "y": 656
    },
    {
      "id": "N162",
      "x": 1426,
      "y": 653
    },
    {
      "id": "N163",
      "x": 1243,
      "y": 731
    },
    {
      "id": "N164",
      "x": 1128,
      "y": 354
    },
    {
      "id": "N165",
      "x": 1136,
      "y": 605
    },
    {
      "id": "N166",
      "x": 1308,
      "y": 418
    }
  ],
  "edges": [
    {
      "a": "N3",
      "b": "N2"
    },
    {
      "a": "N2",
      "b": "N4"
    },
    {
      "a": "N4",
      "b": "N5"
    },
    {
      "a": "N4",
      "b": "N6"
    },
    {
      "a": "N6",
      "b": "N8"
    },
    {
      "a": "N6",
      "b": "N7"
    },
    {
      "a": "N7",
      "b": "N2"
    },
    {
      "a": "N8",
      "b": "N58"
    },
    {
      "a": "N58",
      "b": "N84"
    },
    {
      "a": "N84",
      "b": "N83"
    },
    {
      "a": "N83",
      "b": "N82"
    },
    {
      "a": "N82",
      "b": "N81"
    },
    {
      "a": "N81",
      "b": "N80"
    },
    {
      "a": "N80",
      "b": "N79"
    },
    {
      "a": "N79",
      "b": "N78"
    },
    {
      "a": "N78",
      "b": "N77"
    },
    {
      "a": "N77",
      "b": "N76"
    },
    {
      "a": "N76",
      "b": "N65"
    },
    {
      "a": "N65",
      "b": "N64"
    },
    {
      "a": "N64",
      "b": "N63"
    },
    {
      "a": "N63",
      "b": "N62"
    },
    {
      "a": "N62",
      "b": "N66"
    },
    {
      "a": "N66",
      "b": "N65"
    },
    {
      "a": "N62",
      "b": "N61"
    },
    {
      "a": "N61",
      "b": "N67"
    },
    {
      "a": "N67",
      "b": "N68"
    },
    {
      "a": "N61",
      "b": "N75"
    },
    {
      "a": "N76",
      "b": "N75"
    },
    {
      "a": "N75",
      "b": "N74"
    },
    {
      "a": "N58",
      "b": "N88"
    },
    {
      "a": "N88",
      "b": "N87"
    },
    {
      "a": "N87",
      "b": "N86"
    },
    {
      "a": "N83",
      "b": "N85"
    },
    {
      "a": "N85",
      "b": "N86"
    },
    {
      "a": "N58",
      "b": "N59"
    },
    {
      "a": "N8",
      "b": "N9"
    },
    {
      "a": "N9",
      "b": "N10"
    },
    {
      "a": "N10",
      "b": "N11"
    },
    {
      "a": "N11",
      "b": "N59"
    },
    {
      "a": "N11",
      "b": "N12"
    },
    {
      "a": "N12",
      "b": "N89"
    },
    {
      "a": "N89",
      "b": "N7"
    },
    {
      "a": "N89",
      "b": "N37"
    },
    {
      "a": "N37",
      "b": "N36"
    },
    {
      "a": "N36",
      "b": "N35"
    },
    {
      "a": "N35",
      "b": "N13"
    },
    {
      "a": "N13",
      "b": "N12"
    },
    {
      "a": "N35",
      "b": "N90"
    },
    {
      "a": "N90",
      "b": "N14"
    },
    {
      "a": "N14",
      "b": "N15"
    },
    {
      "a": "N14",
      "b": "N17"
    },
    {
      "a": "N17",
      "b": "N16"
    },
    {
      "a": "N16",
      "b": "N32"
    },
    {
      "a": "N17",
      "b": "N18"
    },
    {
      "a": "N18",
      "b": "N19"
    },
    {
      "a": "N19",
      "b": "N20"
    },
    {
      "a": "N20",
      "b": "N13"
    },
    {
      "a": "N20",
      "b": "N21"
    },
    {
      "a": "N21",
      "b": "N22"
    },
    {
      "a": "N22",
      "b": "N60"
    },
    {
      "a": "N22",
      "b": "N23"
    },
    {
      "a": "N23",
      "b": "N19"
    },
    {
      "a": "N18",
      "b": "N28"
    },
    {
      "a": "N18",
      "b": "N24"
    },
    {
      "a": "N24",
      "b": "N60"
    },
    {
      "a": "N59",
      "b": "N60"
    },
    {
      "a": "N24",
      "b": "N61"
    },
    {
      "a": "N24",
      "b": "N25"
    },
    {
      "a": "N25",
      "b": "N26"
    },
    {
      "a": "N26",
      "b": "N27"
    },
    {
      "a": "N27",
      "b": "N28"
    },
    {
      "a": "N28",
      "b": "N29"
    },
    {
      "a": "N29",
      "b": "N30"
    },
    {
      "a": "N30",
      "b": "N26"
    },
    {
      "a": "N25",
      "b": "N31"
    },
    {
      "a": "N31",
      "b": "N32"
    },
    {
      "a": "N32",
      "b": "N33"
    },
    {
      "a": "N33",
      "b": "N34"
    },
    {
      "a": "N50",
      "b": "N33"
    },
    {
      "a": "N50",
      "b": "N54"
    },
    {
      "a": "N54",
      "b": "N91"
    },
    {
      "a": "N50",
      "b": "N49"
    },
    {
      "a": "N49",
      "b": "N48"
    },
    {
      "a": "N48",
      "b": "N47"
    },
    {
      "a": "N47",
      "b": "N46"
    },
    {
      "a": "N46",
      "b": "N44"
    },
    {
      "a": "N44",
      "b": "N45"
    },
    {
      "a": "N44",
      "b": "N43"
    },
    {
      "a": "N43",
      "b": "N42"
    },
    {
      "a": "N42",
      "b": "N39"
    },
    {
      "a": "N39",
      "b": "N38"
    },
    {
      "a": "N38",
      "b": "N37"
    },
    {
      "a": "N39",
      "b": "N40"
    },
    {
      "a": "N40",
      "b": "N41"
    },
    {
      "a": "N25",
      "b": "N69"
    },
    {
      "a": "N69",
      "b": "N68"
    },
    {
      "a": "N69",
      "b": "N70"
    },
    {
      "a": "N70",
      "b": "N71"
    },
    {
      "a": "N71",
      "b": "N72"
    },
    {
      "a": "N72",
      "b": "N73"
    },
    {
      "a": "N73",
      "b": "N67"
    },
    {
      "a": "N72",
      "b": "N74"
    },
    {
      "a": "N74",
      "b": "N56"
    },
    {
      "a": "N56",
      "b": "N31"
    },
    {
      "a": "N56",
      "b": "N57"
    },
    {
      "a": "N57",
      "b": "N107"
    },
    {
      "a": "N107",
      "b": "N106"
    },
    {
      "a": "N106",
      "b": "N55"
    },
    {
      "a": "N55",
      "b": "N31"
    },
    {
      "a": "N55",
      "b": "N105"
    },
    {
      "a": "N105",
      "b": "N104"
    },
    {
      "a": "N104",
      "b": "N103"
    },
    {
      "a": "N103",
      "b": "N102"
    },
    {
      "a": "N102",
      "b": "N96"
    },
    {
      "a": "N96",
      "b": "N54"
    },
    {
      "a": "N91",
      "b": "N92"
    },
    {
      "a": "N54",
      "b": "N95"
    },
    {
      "a": "N92",
      "b": "N94"
    },
    {
      "a": "N92",
      "b": "N93"
    },
    {
      "a": "N93",
      "b": "N99"
    },
    {
      "a": "N99",
      "b": "N100"
    },
    {
      "a": "N100",
      "b": "N101"
    },
    {
      "a": "N96",
      "b": "N97"
    },
    {
      "a": "N97",
      "b": "N98"
    },
    {
      "a": "N99",
      "b": "N121"
    },
    {
      "a": "N121",
      "b": "N122"
    },
    {
      "a": "N122",
      "b": "N123"
    },
    {
      "a": "N123",
      "b": "N124"
    },
    {
      "a": "N123",
      "b": "N125"
    },
    {
      "a": "N125",
      "b": "N105"
    },
    {
      "a": "N125",
      "b": "N126"
    },
    {
      "a": "N126",
      "b": "N128"
    },
    {
      "a": "N126",
      "b": "N129"
    },
    {
      "a": "N126",
      "b": "N127"
    },
    {
      "a": "N129",
      "b": "N164"
    },
    {
      "a": "N164",
      "b": "N130"
    },
    {
      "a": "N93",
      "b": "N131"
    },
    {
      "a": "N131",
      "b": "N132"
    },
    {
      "a": "N131",
      "b": "N130"
    },
    {
      "a": "N129",
      "b": "N116"
    },
    {
      "a": "N116",
      "b": "N117"
    },
    {
      "a": "N117",
      "b": "N55"
    },
    {
      "a": "N117",
      "b": "N118"
    },
    {
      "a": "N118",
      "b": "N120"
    },
    {
      "a": "N120",
      "b": "N106"
    },
    {
      "a": "N107",
      "b": "N111"
    },
    {
      "a": "N111",
      "b": "N108"
    },
    {
      "a": "N108",
      "b": "N110"
    },
    {
      "a": "N108",
      "b": "N109"
    },
    {
      "a": "N115",
      "b": "N165"
    },
    {
      "a": "N165",
      "b": "N116"
    },
    {
      "a": "N111",
      "b": "N115"
    },
    {
      "a": "N57",
      "b": "N113"
    },
    {
      "a": "N113",
      "b": "N112"
    },
    {
      "a": "N112",
      "b": "N111"
    },
    {
      "a": "N112",
      "b": "N114"
    },
    {
      "a": "N114",
      "b": "N115"
    },
    {
      "a": "N111",
      "b": "N120"
    },
    {
      "a": "N118",
      "b": "N119"
    },
    {
      "a": "N116",
      "b": "N133"
    },
    {
      "a": "N133",
      "b": "N146"
    },
    {
      "a": "N146",
      "b": "N147"
    },
    {
      "a": "N147",
      "b": "N148"
    },
    {
      "a": "N148",
      "b": "N149"
    },
    {
      "a": "N149",
      "b": "N139"
    },
    {
      "a": "N149",
      "b": "N150"
    },
    {
      "a": "N150",
      "b": "N151"
    },
    {
      "a": "N139",
      "b": "N152"
    },
    {
      "a": "N152",
      "b": "N153"
    },
    {
      "a": "N153",
      "b": "N154"
    },
    {
      "a": "N153",
      "b": "N136"
    },
    {
      "a": "N136",
      "b": "N145"
    },
    {
      "a": "N136",
      "b": "N137"
    },
    {
      "a": "N137",
      "b": "N138"
    },
    {
      "a": "N138",
      "b": "N139"
    },
    {
      "a": "N137",
      "b": "N135"
    },
    {
      "a": "N135",
      "b": "N155"
    },
    {
      "a": "N155",
      "b": "N156"
    },
    {
      "a": "N156",
      "b": "N163"
    },
    {
      "a": "N163",
      "b": "N140"
    },
    {
      "a": "N156",
      "b": "N157"
    },
    {
      "a": "N157",
      "b": "N158"
    },
    {
      "a": "N158",
      "b": "N159"
    },
    {
      "a": "N157",
      "b": "N160"
    },
    {
      "a": "N160",
      "b": "N161"
    },
    {
      "a": "N161",
      "b": "N162"
    },
    {
      "a": "N162",
      "b": "N134"
    },
    {
      "a": "N134",
      "b": "N135"
    },
    {
      "a": "N134",
      "b": "N143"
    },
    {
      "a": "N143",
      "b": "N141"
    },
    {
      "a": "N141",
      "b": "N142"
    },
    {
      "a": "N143",
      "b": "N144"
    },
    {
      "a": "N144",
      "b": "N145"
    },
    {
      "a": "N146",
      "b": "N166"
    },
    {
      "a": "N145",
      "b": "N166"
    },
    {
      "a": "N140",
      "b": "N133"
    }
  ]
}

const IMAGE_NAME = "tdtu_map.png"; // put this image next to the HTML file

// --------------------- DOM refs ---------------------
const canvas = document.getElementById("mapCanvas");
const ctx = canvas.getContext("2d", {alpha:false});
const snapRange = document.getElementById("snapRange");
const snapVal = document.getElementById("snapVal");
const pathOutput = document.getElementById("pathOutput");
const nodeCountSpan = document.getElementById("nodeCount");
const edgeCountSpan = document.getElementById("edgeCount");
const btnExport = document.getElementById("btnExport");
const btnResetPath = document.getElementById("btnResetPath");
const btnReload = document.getElementById("btnReload");
const btnLoadJson = document.getElementById("btnLoadJson");
const btnClearJson = document.getElementById("btnClearJson");
const jsonText = document.getElementById("jsonText");
const editToggle = document.getElementById("editToggle");
const btnHelp = document.getElementById("btnHelp");
const helpModal = document.getElementById("helpModal");
const closeHelp = document.getElementById("closeHelp");

// --------------------- State ---------------------
let img = new Image();
img.src = IMAGE_NAME;
let imgW = 1200, imgH = 800; // defaults until image loads

// Transform state (map + graph are drawn in same transform)
let scale = 1.0;
let tx = 0; // translate x in canvas px
let ty = 0; // translate y in canvas px
const MIN_SCALE = 0.2, MAX_SCALE = 6;

// pan interaction
let isPanning = false;
let lastPan = {x:0,y:0};

// nodes/edges (nodes stored in image pixel coordinates)
let nodes = [];
let edges = [];

// selection / path state
let startNode = null, endNode = null, currentPath = [];

// edit mode for moving nodes
let editMode = false;
let draggingNode = null;
let dragNodeOffset = {x:0,y:0};

// render control
let needsRender = true;

// --------------------- Init graph ---------------------
function initGraphFromEmbedded(){
  nodes = embeddedGraph.nodes.map(n=>({ id: String(n.id), x: Number(n.x), y: Number(n.y) }));
  edges = embeddedGraph.edges.map(e=>({ a:String(e.a), b:String(e.b) }));
  nodeCountSpan.textContent = nodes.length;
  edgeCountSpan.textContent = edges.length;
  startNode = endNode = null; currentPath = [];
  markDirty();
}

// --------------------- Helpers: coords transform ---------------------
// image (px) -> canvas px (apply scale & translate)
function imageToCanvas(ix, iy){
  return { x: ix * scale + tx, y: iy * scale + ty };
}
// canvas px -> image px (inverse)
function canvasToImage(cx, cy){
  return { x: (cx - tx) / scale, y: (cy - ty) / scale };
}
// get node by id
function getNode(id){ return nodes.find(n=>n.id===id); }

// nearest node by canvas coords; returns {node, distCanvas}
function nearestNodeByCanvas(cx, cy){
  let best = null, bd = Infinity;
  for(const n of nodes){
    const c = imageToCanvas(n.x, n.y);
    const d = Math.hypot(c.x - cx, c.y - cy);
    if(d < bd){ bd = d; best = n; }
  }
  return { node: best, dist: bd };
}

// --------------------- Build adjacency + Dijkstra ---------------------
function buildGraphAdj(){
  const G = {};
  for(const n of nodes) G[n.id] = {};
  for(const e of edges){
    const a = getNode(e.a), b = getNode(e.b);
    if(!a || !b) continue;
    const w = Math.hypot(a.x - b.x, a.y - b.y); // weight in image px
    G[e.a][e.b] = w;
    G[e.b][e.a] = w;
  }
  return G;
}

function dijkstra(graph, start, goal){
  if(!graph[start] || !graph[goal]) return {path:[], dist: Infinity};
  const dist = {}, prev = {};
  const Q = new Set(Object.keys(graph));
  for(const v of Q) dist[v] = Infinity;
  dist[start] = 0;
  while(Q.size){
    // extract min
    let u = null, best = Infinity;
    for(const v of Q) if(dist[v] < best){ best = dist[v]; u = v; }
    if(u === null) break;
    Q.delete(u);
    if(u === goal) break;
    for(const [v,w] of Object.entries(graph[u]||{})){
      if(!Q.has(v)) continue;
      const alt = dist[u] + w;
      if(alt < dist[v]){ dist[v] = alt; prev[v] = u; }
    }
  }
  if(dist[goal] === Infinity) return {path:[], dist: Infinity};
  const path = []; let u = goal;
  while(u !== undefined){ path.unshift(u); if(u === start) break; u = prev[u]; if(u===undefined) break; }
  return {path, dist: Math.round(dist[goal])};
}

// --------------------- Rendering ---------------------
function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }

// draw everything using current transform
function drawScene(){
  clearCanvas();
  // draw image
  // drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh) - we use simple scale+translate
  ctx.save();
  ctx.setTransform(scale, 0, 0, scale, tx, ty);
  ctx.imageSmoothingEnabled = true;
  ctx.drawImage(img, 0, 0, imgW, imgH);
  // draw edges (in image coordinate space)
  ctx.lineWidth = Math.max(2 / scale, 1.2); // adjust for scale so lines look consistent
  ctx.strokeStyle = "#000"; ctx.lineJoin = "round"; ctx.lineCap = "round";
  ctx.beginPath();
  for(const e of edges){
    const a = getNode(e.a), b = getNode(e.b);
    if(!a||!b) continue;
    ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y);
  }
  ctx.stroke();

  // draw current path (thicker)
  if(currentPath && currentPath.length>1){
    ctx.lineWidth = Math.max(6/scale, 3);
    ctx.strokeStyle = "rgba(220,30,30,1)";
    ctx.beginPath();
    for(let i=0;i<currentPath.length;i++){
      const n = getNode(currentPath[i]);
      if(!n) continue;
      if(i===0) ctx.moveTo(n.x, n.y); else ctx.lineTo(n.x, n.y);
    }
    ctx.stroke();
  }

  // draw nodes
  for(const n of nodes){
    const r = Math.max(4/scale, 3.5);
    ctx.beginPath();
    ctx.fillStyle = "#ffd86b";
    ctx.strokeStyle = "#4b3000";
    ctx.lineWidth = Math.max(1/scale,0.8);
    ctx.arc(n.x, n.y, r, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();
  }

  // start/end markers
  if(startNode){ const s = getNode(startNode); if(s){ ctx.beginPath(); ctx.fillStyle="blue"; ctx.arc(s.x, s.y, Math.max(9/scale,6),0,Math.PI*2); ctx.fill(); } }
  if(endNode){ const e = getNode(endNode); if(e){ ctx.beginPath(); ctx.fillStyle="lime"; ctx.arc(e.x, e.y, Math.max(9/scale,6),0,Math.PI*2); ctx.fill(); } }

  ctx.restore();
}

// requestAnimationFrame loop with dirty flag
function renderLoop(){
  if(needsRender){ drawScene(); needsRender = false; }
  requestAnimationFrame(renderLoop);
}
function markDirty(){ needsRender = true; }

// --------------------- Interaction: pan/zoom ---------------------
function resizeCanvasToFit(){
  // make canvas fill its container while preserving image aspect ratio
  const wrap = document.getElementById("canvasWrap");
  const rect = wrap.getBoundingClientRect();
  // set canvas size to container size
  canvas.width = Math.max(300, Math.round(rect.width));
  canvas.height = Math.max(200, Math.round(rect.height));
  markDirty();
}

// Pan: drag anywhere (unless editing node)
canvas.addEventListener("mousedown", (ev)=>{
  // left button only
  if(ev.button !== 0) return;
  // if editMode and clicked on node, node dragging handled elsewhere
  if(editMode){
    // check if clicked on node
    const rect = canvas.getBoundingClientRect();
    const cx = ev.clientX - rect.left, cy = ev.clientY - rect.top;
    const res = nearestNodeByCanvas(cx, cy);
    const thresh = Number(snapRange.value);
    if(res.node && res.dist <= thresh){
      // begin dragging node
      draggingNode = res.node;
      // compute offset in image coords: store where pointer relative to node (image px)
      const imgPos = canvasToImage(cx, cy);
      dragNodeOffset.x = draggingNode.x - imgPos.x;
      dragNodeOffset.y = draggingNode.y - imgPos.y;
      canvas.style.cursor = "grabbing";
      return; // don't start pan
    }
  }
  isPanning = true;
  lastPan.x = ev.clientX; lastPan.y = ev.clientY;
  canvas.style.cursor = "grabbing";
});

window.addEventListener("mousemove", (ev)=>{
  // dragging node?
  if(draggingNode){
    const rect = canvas.getBoundingClientRect();
    const cx = ev.clientX - rect.left, cy = ev.clientY - rect.top;
    const imgPos = canvasToImage(cx, cy);
    // update node position in image coords
    draggingNode.x = imgPos.x + dragNodeOffset.x;
    draggingNode.y = imgPos.y + dragNodeOffset.y;
    markDirty();
    return;
  }
  if(!isPanning) return;
  const dx = ev.clientX - lastPan.x;
  const dy = ev.clientY - lastPan.y;
  tx += dx; ty += dy;
  lastPan.x = ev.clientX; lastPan.y = ev.clientY;
  markDirty();
});

window.addEventListener("mouseup", ()=>{ if(isPanning||draggingNode){ isPanning=false; draggingNode=null; canvas.style.cursor="grab"; markDirty(); } });

// wheel zoom centered on mouse
canvas.addEventListener("wheel", (ev)=>{
  ev.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const mx = ev.clientX - rect.left, my = ev.clientY - rect.top;
  const delta = -ev.deltaY;
  const factor = delta > 0 ? 1.12 : 0.88;
  const oldScale = scale;
  let newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, oldScale * factor));
  // keep point under mouse stable: compute image coord under mouse, then recompute tx/ty
  const imgX = (mx - tx)/oldScale, imgY = (my - ty)/oldScale;
  tx = mx - imgX * newScale;
  ty = my - imgY * newScale;
  scale = newScale;
  markDirty();
}, {passive:false});

// --------------------- Click handling: selecting nodes for path ---------------------
canvas.addEventListener("click", (ev)=>{
  // if editing and dragging node, ignore click
  if(draggingNode) return;
  const rect = canvas.getBoundingClientRect();
  const cx = ev.clientX - rect.left, cy = ev.clientY - rect.top;
  const res = nearestNodeByCanvas(cx, cy);
  const thresh = Number(snapRange.value);
  if(!res.node || res.dist > thresh){
    pathOutput.textContent = `Click too far from node (${Math.round(res.dist)} px). Increase snap threshold or click closer.`;
    return;
  }
  if(!startNode){
    startNode = res.node.id; pathOutput.textContent = `Start = ${startNode}. Click End.`; markDirty(); return;
  }
  if(!endNode){
    endNode = res.node.id; pathOutput.textContent = `End = ${endNode}. Computing...`; computeAndShow(); return;
  }
  // both set => treat as new start
  startNode = res.node.id; endNode = null; currentPath = []; pathOutput.textContent = `Restart: Start = ${startNode}. Click End.`; markDirty();
});

// compute path and display
function computeAndShow(){
  const G = buildGraphAdj();
  if(!G[startNode] || !G[endNode]){ pathOutput.textContent = "Start/End not in graph"; return; }
  const r = dijkstra(G, startNode, endNode);
  if(r.path.length === 0){ pathOutput.textContent = `No path between ${startNode} and ${endNode}.`; return; }
  currentPath = r.path;
  pathOutput.textContent = `Path: ${r.path.join(" â†’ ")}\nLength: ${r.dist} px (image units)`;
  markDirty();
}

// --------------------- Buttons & UI ---------------------
snapRange.addEventListener("input", ()=>{ snapVal.textContent = snapRange.value; });
snapVal.textContent = snapRange.value;

btnResetPath.addEventListener("click", ()=>{
  startNode = null; endNode = null; currentPath = [];
  pathOutput.textContent = "Path reset. Click Start then End.";
  markDirty();
});

btnReload.addEventListener("click", ()=>{
  initGraphFromEmbedded();
  // reset transform
  scale = Math.min(canvas.width / imgW, canvas.height / imgH);
  // center image
  tx = (canvas.width - imgW*scale)/2;
  ty = (canvas.height - imgH*scale)/2;
  pathOutput.textContent = "Graph reloaded and transform reset.";
  markDirty();
});

btnLoadJson.addEventListener("click", ()=>{
  const txt = jsonText.value.trim();
  if(!txt){ alert("Paste JSON into textarea first."); return; }
  try{
    const obj = JSON.parse(txt);
    if(!Array.isArray(obj.nodes) || !Array.isArray(obj.edges)){ alert("Invalid graph JSON format."); return; }
    nodes = obj.nodes.map(n=>({id:String(n.id), x:Number(n.x), y:Number(n.y)}));
    edges = obj.edges.map(e=>({a:String(e.a), b:String(e.b)}));
    nodeCountSpan.textContent = nodes.length; edgeCountSpan.textContent = edges.length;
    startNode = endNode = null; currentPath = [];
    pathOutput.textContent = "Custom graph loaded from paste.";
    markDirty();
  }catch(err){ alert("Invalid JSON: " + err); }
});
btnClearJson.addEventListener("click", ()=>{ jsonText.value = ""; });

btnExport.addEventListener("click", ()=>{
  // Export node positions in image pixel units (round)
  const exportNodes = nodes.map(n=>({ id:n.id, x: Math.round(n.x), y: Math.round(n.y) }));
  const payload = { nodes: exportNodes, edges: edges };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "tdtu_graph_aligned.json"; document.body.appendChild(a); a.click(); a.remove();
});

// Edit toggle
editToggle.addEventListener("change", (ev)=>{
  editMode = !!ev.target.checked;
  // change cursor hint
  canvas.style.cursor = editMode ? "crosshair" : "grab";
});

// Help modal
btnHelp.addEventListener("click", ()=>{ helpModal.style.display = "flex"; });
closeHelp.addEventListener("click", ()=>{ helpModal.style.display = "none"; });
helpModal.addEventListener("click", (ev)=>{ if(ev.target === helpModal) helpModal.style.display = "none"; });

// --------------------- Window events ---------------------
window.addEventListener("resize", ()=>{ resizeCanvasToFit(); markDirty(); });

// --------------------- Initialization ---------------------
img.onload = ()=>{
  imgW = img.naturalWidth; imgH = img.naturalHeight;
  resizeCanvasToFit();
  // initial scale to fit canvas
  scale = Math.min(canvas.width / imgW, canvas.height / imgH);
  tx = (canvas.width - imgW*scale)/2;
  ty = (canvas.height - imgH*scale)/2;
  initGraphFromEmbedded();
  // update UI counts
  nodeCountSpan.textContent = nodes.length;
  edgeCountSpan.textContent = edges.length;
  pathOutput.textContent = "Map & graph loaded. KÃ©o Ä‘á»ƒ di chuyá»ƒn, wheel Ä‘á»ƒ zoom. Click Start then End.";
  markDirty();
};

// Start render loop
renderLoop();

// initialize sizes (in case image loads instantly from cache)
setTimeout(()=>{ if(img.complete) { resizeCanvasToFit(); markDirty(); } }, 200);

</script>
</body>
</html>
